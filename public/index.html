<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Signature Pad demo</title>
  <meta name="description" content="Signature Pad - HTML5 canvas based smooth signature drawing using variable width spline interpolation.">

  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no">

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <link rel="stylesheet" href="css/signature-pad.css" type="text/css">
  
  <script type='text/javascript' src="./js/W3.js"></script>
  <script type='text/javascript' src="./js/svgo.js"></script>


  <script type="text/javascript">

    const initialize = () => {
      //Basic Actions Section
      const onboardButton = document.getElementById('onboardButton');
      const getAccountsButton = document.getElementById('getAccountsButton');
      const mintAutographButton = document.getElementById('mintAutographButton');
      const errorMessageHeader = document.getElementById('errorMessageHeader');
      const signatureName = document.getElementById('signatureName');
      // signatureName.innerHTML = "todo" // get from url

      // const getAccountsResult = document.getElementById('getAccountsResultButton');

      //Created check function to see if the MetaMask extension is installed
      const isMetaMaskInstalled = () => {
        //Have to check the ethereum binding on the window object to see if it's installed
        const { ethereum } = window;
        return Boolean(ethereum && ethereum.isMetaMask);
      };

      //We create a new MetaMask onboarding object to use in our app
      // const onboarding = new MetaMaskOnboarding({ forwarderOrigin });

      //This will start the onboarding proccess
      const onClickInstall = () => {
        onboardButton.innerText = 'Onboarding in progress';
        onboardButton.disabled = true;
        //On this object we have startOnboarding which will start the onboarding process for our end user
        //
        window.open('https://chrome.google.com/webstore/detail/metamask/nkbihfbeogaeaoehlefnkodbefgpgknn','_blank')
        // onboarding.startOnboarding();
      };

      const onClickConnect = async () => {
        try {
          // Will open the MetaMask UI
          // You should disable this button while the request is pending!
          await ethereum.request({ method: 'eth_requestAccounts' });

          //we use eth_accounts because it returns a list of addresses owned by us.

        } catch (error) {
          console.error(error);
          // getAccountsResult.innerHTML = 'Not able to get accounts';
        }
          const accounts = await ethereum.request({ method: 'eth_accounts' });
          //We take the first address in the array of addresses and display it
          // getAccountsResult.innerHTML = accounts[0] || 'Not able to get accounts';
      };

      const MetaMaskClientCheck = () => {
        //Now we check to see if Metmask is installed
        if (!isMetaMaskInstalled()) {
          //If it isn't installed we ask the user to click to install it
          onboardButton.innerText = 'Click here to install MetaMask!';
          //When the button is clicked we call th is function
          onboardButton.onclick = onClickInstall;
          //The button is now disabled
          onboardButton.disabled = false;
        } else {
          //If MetaMask is installed we ask the user to connect to their wallet
          onboardButton.innerText = 'Connect';
          //When the button is clicked we call this function to connect the users MetaMask Wallet
          onboardButton.onclick = onClickConnect;
          //The button is now disabled
          onboardButton.disabled = false;
        }
      };

      // //Eth_Accounts-getAccountsButton
      // getAccountsButton.addEventListener('click', async () => {
      //   //we use eth_accounts because it returns a list of addresses owned by us.
      //   const accounts = await ethereum.request({ method: 'eth_accounts' });
      //   //We take the first address in the array of addresses and display it
      //   getAccountsResult.innerHTML = accounts[0] || 'Not able to get accounts';
      // });

        var abi = [{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"approved","type":"address"},{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"operator","type":"address"},{"indexed":false,"internalType":"bool","name":"approved","type":"bool"}],"name":"ApprovalForAll","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"Transfer","type":"event"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"approve","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"name":"autographSvgs","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"baseTokenURI","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"name":"exists","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getApproved","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"operator","type":"address"}],"name":"isApprovedForAll","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"name","type":"string"},{"internalType":"string","name":"svg","type":"string"}],"name":"mint","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"name":"names","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"ownerOf","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"renounceOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"safeTransferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"},{"internalType":"bytes","name":"data","type":"bytes"}],"name":"safeTransferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"operator","type":"address"},{"internalType":"bool","name":"approved","type":"bool"}],"name":"setApprovalForAll","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"newURI","type":"string"}],"name":"setBaseURI","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes4","name":"interfaceId","type":"bytes4"}],"name":"supportsInterface","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"tokenSvgHash","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"tokenURI","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"transferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"}]


      var address = "0xE1265B7d94fFaE79C75F59e3a454a29e7235b1D3"
      var w3 = new W3()
      w3.setProvider('https://kovan.infura.io/v3/3cb706370956464e9cd6aebdd1c9980d')
      var a = new w3.eth.Contract(abi, address)
      mintAutographButton.addEventListener('click', async () => {
        errorMessageHeader.innerHTML = ""
        const accounts = await ethereum.request({ method: 'eth_accounts' });

        var svg = signaturePad._toSVG(true)
        var optimized = optimize(svg)

        function optimize(input){
          const result = svgo(input, {
            floatPrecision: 0
          });
          return result.data;
        }

        // var encodedTxdata = a.methods.mint("Vitalik Buterin", svg).encodeABI()
        // if(accounts && accounts[0]){
        //   var params = [
        //     {
        //       from: accounts[0],
        //       to: '0xE1265B7d94fFaE79C75F59e3a454a29e7235b1D3',
        //       // value: '0x00',
        //       // data: '0x12345678'
        //       data: encodedTxdata
        //     },
        //   ];

        //   ethereum
        //     .request({
        //       method: 'eth_sendTransaction',
        //       params,
        //     })
        //     .then((result) => {
        //       // The result varies by RPC method.
        //       // For example, this method will return a transaction hash hexadecimal string on success.
        //     })
        //     .catch((error) => {
        //       // If the request fails, the Promise will reject with an error.
        //     });
        // }else{
        //   errorMessageHeader.innerHTML = "please connect an account"
        // }
      });
      MetaMaskClientCheck();
    };
    window.addEventListener('DOMContentLoaded', initialize);

  </script>
</head>
<body onselectstart="return false">

  <div id="signature-pad" class="signature-pad">
    <div class="signature-pad--body">
      <canvas></canvas>
    </div>
    <div class="signature-pad--footer">
<!--      <div class="description">Sign autograph above</div>-->
      <div><h3 id="signatureName"></h3></div>

      <div class="signature-pad--actions">
        <div>
          <span id="getAccountsResult"></span><
          <span id="errorMessageHeader"></span>
          <button id="onboardButton" class="button">do!</button>
          <button type="button" class="button" data-action="clear">Clear</button>
          <button type="button" class="button" data-action="save-svg">Save as SVG</button>
          <button id="mintAutographButton" class="button" type="button" >Mint</button>
        </div>
      </div>
    </div>
  </div>

  <script type='text/javascript' src="./js/signature_pad.umd.js"></script>
  <script type='text/javascript' src="./js/app.js"></script>

</body>
</html>
